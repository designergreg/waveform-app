<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Video Agent</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:sans-serif; }
#startScreen,#agentScreen { width:100%; height:100%; position:absolute; top:0; left:0; }
#startScreen { display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg,#3954A7 0%,#305E7C 100%); }
#startBtn { padding:20px 40px; font-size:20px; cursor:pointer; border:none; border-radius:999px; background:white; color:#1F465D; }
#agentScreen { display:none; }
#bgVideo { position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:-2; }
.actionbar { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:343px; height:60px; border-radius:30px; background:rgba(0,0,0,0.25); display:flex; align-items:center; justify-content:space-between; padding:0 6px; overflow:hidden; z-index:0; }
#wave { position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; }
.icon-button { width:48px; height:48px; border-radius:24px; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); display:flex; align-items:center; justify-content:center; z-index:1; cursor:pointer; }
.icon-button img { width:24px; height:24px; object-fit:contain; filter:brightness(0) invert(1); }
.icon-button:hover { background:#1F4C7D; }
</style>
</head>
<body>

<div id="startScreen">
  <button id="startBtn">Allow Mic Access</button>
</div>

<div id="agentScreen">
  <video id="bgVideo" src="therapist_silent_30.mp4" autoplay loop muted playsinline></video>

  <div class="actionbar">
    <canvas id="wave"></canvas>
    <div class="icon-button"><img src="icons/linear/pause.svg" alt="Pause"></div>
    <div class="icon-button"><img src="icons/linear/more.svg" alt="More"></div>
  </div>
</div>

<script>
/* ---------- Canvas ---------- */
const canvas=document.getElementById("wave"),ctx=canvas.getContext("2d");
function resize(){canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight;}
window.addEventListener("resize", resize);

/* ---------- Mobile ---------- */
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

/* ---------- Audio ---------- */
let micInitialized=false, smoothedRMS=0, targetAmplitude=0;
const BASE_AMPLITUDE=isMobile?20:12, MIN_WAVE=isMobile?15:10, RESPONSIVE_BOOST=isMobile?180:120, VOICE_Y_SHIFT=isMobile?30:20;
const RMS_MULTIPLIER=isMobile?12:5, RMS_EXPONENT=isMobile?1.4:1.2;
let audioCtx=null, analyser=null, buffer=null;

async function initAudio(stream){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state==="suspended") await audioCtx.resume();
    const source = audioCtx.createMediaStreamSource(stream);
    const gainNode = audioCtx.createGain();
    gainNode.gain.value = isMobile?14:1;
    analyser = audioCtx.createAnalyser();
    analyser.fftSize=512;
    buffer = new Uint8Array(analyser.frequencyBinCount);
    source.connect(gainNode);
    gainNode.connect(analyser);
}

/* ---------- Audio Loop ---------- */
function audioLoop(){
  if(!analyser||!buffer){requestAnimationFrame(audioLoop); return;}
  analyser.getByteTimeDomainData(buffer);
  let sum=0;
  for(let i=0;i<buffer.length;i++){const v=(buffer[i]-128)/128; sum+=v*v;}
  let rawRMS=Math.sqrt(sum/buffer.length);
  if(rawRMS<0.005) rawRMS=0;
  const scaledRMS=Math.pow(rawRMS*RMS_MULTIPLIER,RMS_EXPONENT);
  const ATTACK=0.8, RELEASE=0.05;
  if(scaledRMS>smoothedRMS) smoothedRMS = smoothedRMS*(1-ATTACK)+scaledRMS*ATTACK;
  else smoothedRMS = smoothedRMS*(1-RELEASE)+scaledRMS*RELEASE;
  targetAmplitude = MIN_WAVE+BASE_AMPLITUDE+smoothedRMS*RESPONSIVE_BOOST;
  requestAnimationFrame(audioLoop);
}

/* ---------- Wave ---------- */
const noise={grad:Array.from({length:256},()=>Math.random()*2-1),fade:t=>t*t*t*(t*(t*6-15)+10),lerp:(a,b,t)=>a+(b-a)*t,get(x){const X=Math.floor(x)&255;const t2=x-Math.floor(x);const g1=this.grad[X],g2=this.grad[X+1];return this.lerp(g1*t2,g2*(t2-1),this.fade(t2));}};
const speed=0.004, layers=[{color:'#5A8696',alpha:0.6,xShift:0},{color:'#CD568A',alpha:0.6,xShift:80},{color:'#9E6FA8',alpha:0.6,xShift:160},{color:'#0D4CAC',alpha:0.7,xShift:240}];
let t=0, isTalking=false, fadeFactor=1, FADE_SPEED=0.05;
window.addEventListener("keydown",e=>{if(e.code==="Space") isTalking=true;});
window.addEventListener("keyup",e=>{if(e.code==="Space") isTalking=false;});
["touchstart","touchend","touchcancel"].forEach(evt=>{document.body.addEventListener(evt,e=>{if(evt==="touchstart"){e.preventDefault();isTalking=true;}else{e.preventDefault();isTalking=false;}},{passive:false});});

function drawWave(layer,width,height,alphaMultiplier=1){
  ctx.beginPath();
  ctx.moveTo(0,height);
  const noiseScale=2/width;
  const dynamicOffset=smoothedRMS*VOICE_Y_SHIFT;
  const baseY=height*0.75-dynamicOffset;
  for(let x=0;x<width;x++){
    const n=noise.get((x+layer.xShift)*noiseScale+t*speed);
    const normalized=n*0.5;
    const y=baseY-normalized*targetAmplitude;
    ctx.lineTo(x,y);
  }
  ctx.lineTo(width,height);
  ctx.closePath();
  const r=parseInt(layer.color.slice(1,3),16),g=parseInt(layer.color.slice(3,5),16),b=parseInt(layer.color.slice(5,7),16);
  ctx.fillStyle=`rgba(${r},${g},${b},${layer.alpha*alphaMultiplier})`;
  ctx.fill();
}

const buttons=document.querySelectorAll(".icon-button");
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(isTalking){fadeFactor+=FADE_SPEED;if(fadeFactor>1) fadeFactor=1;}else{fadeFactor-=FADE_SPEED;if(fadeFactor<0) fadeFactor=0;}
  buttons.forEach(btn=>{btn.style.display=fadeFactor>0?"none":"flex";});
  if(fadeFactor>0) layers.forEach(layer=>drawWave(layer,canvas.width,canvas.height,fadeFactor));
  t+=1;
  requestAnimationFrame(draw);
}

/* ---------- Start Button ---------- */
document.getElementById("startBtn").addEventListener("click", async ()=>{
    if(micInitialized) return;
    try{
        // Directly call getUserMedia inside gesture
        const stream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
        micInitialized=true;
        await initAudio(stream);

        document.getElementById("startScreen").style.display="none";
        document.getElementById("agentScreen").style.display="block";

        const video=document.getElementById("bgVideo");
        video.muted=true; video.playsInline=true;
        await video.play().catch(()=>{});

        resize();
        draw();
        audioLoop();
    }catch(err){
        console.error("Mic permission failed:",err);
        alert("Mic access is required to continue.");
    }
});
</script>
</body>
</html>